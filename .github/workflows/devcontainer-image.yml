name: Devcontainer Image

on:
  push:
    branches:
      - main
    paths:
      - '.devcontainer/**'
      - '.github/workflows/devcontainer-image.yml'
  workflow_dispatch:
  schedule:
    # Weekly trigger; job logic below runs only every second week.
    - cron: '0 4 * * 1'

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide whether scheduled run should publish
        id: cadence
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" != "schedule" ]]; then
            echo "run_publish=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ISO week number; publish only on even weeks (every 2 weeks).
          week_number="$(date +%V)"
          if ((10#$week_number % 2 == 0)); then
            echo "run_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.cadence.outputs.run_publish == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: steps.cadence.outputs.run_publish == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        if: steps.cadence.outputs.run_publish == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/tauri-plugins-workspace-devcontainer
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-
            type=schedule,pattern={{date 'YYYYMMDD'}}

      - name: Build and push image
        if: steps.cadence.outputs.run_publish == 'true'
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: .devcontainer/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Write build summary
        if: steps.cadence.outputs.run_publish == 'true'
        run: |
          echo "## Devcontainer image published" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Image: \`ghcr.io/${{ github.repository_owner }}/tauri-plugins-workspace-devcontainer\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Platforms: \`linux/amd64\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "- Digest: \`${{ steps.build.outputs.digest }}\`" >> "${GITHUB_STEP_SUMMARY}"
          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "### Tags" >> "${GITHUB_STEP_SUMMARY}"
          echo "${{ steps.meta.outputs.tags }}" | sed 's/^/- `/; s/$/`/' >> "${GITHUB_STEP_SUMMARY}"

      - name: Scheduled skip notice
        if: github.event_name == 'schedule' && steps.cadence.outputs.run_publish != 'true'
        run: echo "Skipping this scheduled run to keep a two-week publish cadence."
