name: Covector Version or Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  version-or-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    outputs:
      change: ${{ steps.covector.outputs.change }}
      commandRan: ${{ steps.covector.outputs.commandRan }}
      successfulPublish: ${{ steps.covector.outputs.successfulPublish }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          registry-url: https://registry.npmjs.org
          cache: pnpm

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Validate publish secrets
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "Missing required secret: NPM_TOKEN"
            exit 1
          fi

          if [ -z "${CARGO_REGISTRY_TOKEN}" ]; then
            echo "Missing required secret: CARGO_REGISTRY_TOKEN"
            exit 1
          fi

      - name: Run Covector version or publish
        id: covector
        uses: jbolda/covector/packages/action@covector-v0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          command: version-or-publish
          createRelease: true
          recognizeContributors: true

      - name: Create pull request with version bumps
        if: steps.covector.outputs.commandRan == 'version'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/covector
          title: "chore: publish new versions"
          commit-message: "chore: publish new versions"
          labels: version updates
          body: ${{ steps.covector.outputs.change }}
