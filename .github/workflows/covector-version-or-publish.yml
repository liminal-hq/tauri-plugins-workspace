name: Covector Version or Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  version-or-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 65
    outputs:
      change: ${{ steps.covector.outputs.change }}
      commandRan: ${{ steps.covector.outputs.commandRan }}
      successfulPublish: ${{ steps.covector.outputs.successfulPublish }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up pnpm
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .node-version
          registry-url: https://registry.npmjs.org
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Validate publish secrets
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "${NPM_TOKEN}" ]; then
            echo "Missing required secret: NPM_TOKEN"
            exit 1
          fi

          if [ -z "${CARGO_REGISTRY_TOKEN}" ]; then
            echo "Missing required secret: CARGO_REGISTRY_TOKEN"
            exit 1
          fi

      - name: Run Covector version or publish
        id: covector
        uses: jbolda/covector/packages/action@covector-v0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          command: version-or-publish
          createRelease: true
          recognizeContributors: true

      - name: Apply Prettier formatting to versioned files
        if: steps.covector.outputs.commandRan == 'version'
        run: |
          mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMRT || true)

          if [ "${#changed_files[@]}" -eq 0 ]; then
            echo "No files changed by version step."
            exit 0
          fi

          npx --yes prettier@3 --write --ignore-unknown "${changed_files[@]}"

      - name: Build release pull request metadata
        if: steps.covector.outputs.commandRan == 'version'
        id: pr_meta
        env:
          CHANGE_BODY: ${{ steps.covector.outputs.change }}
        run: |
          node <<'EOF'
          const raw = process.env.CHANGE_BODY ?? '';
          const releaseDate = new Date().toISOString().slice(0, 10);

          const lines = raw.split(/\r?\n/);
          const releases = [];

          for (let i = 0; i < lines.length; i += 1) {
            const pkgMatch = lines[i].match(/^#\s+(.+)$/);
            if (!pkgMatch) {
              continue;
            }

            const pkgName = pkgMatch[1].trim();
            if (/^version updates$/i.test(pkgName)) {
              continue;
            }

            let version = '';

            for (let j = i + 1; j < Math.min(i + 12, lines.length); j += 1) {
              const verMatch = lines[j].match(/^##\s+\[([^\]]+)\]/);
              if (verMatch) {
                version = verMatch[1].trim();
                break;
              }
            }

            if (!version) {
              continue;
            }

            releases.push({ pkgName, version });
          }

          const unique = [];
          const seen = new Set();
          for (const item of releases) {
            const key = `${item.pkgName}@${item.version}`;
            if (!seen.has(key)) {
              seen.add(key);
              unique.push(item);
            }
          }

          const summary = unique.map((item) => `${item.pkgName} ${item.version || ''}`.trim());
          const plainList = summary.join(', ');
          let title = `Release: package versions ${releaseDate}`;
          let commitMessage = `chore(release): package versions ${releaseDate}`;

          if (summary.length === 1) {
            title = `Release: ${summary[0]}`;
            commitMessage = `chore(release): ${summary[0]}`;
          } else if (summary.length === 2) {
            title = `Release: ${summary[0]} and ${summary[1]}`;
            commitMessage = `chore(release): ${summary[0]} and ${summary[1]}`;
          } else if (summary.length > 2) {
            title = `Release: ${summary[0]}, ${summary[1]}, and ${summary.length - 2} more`;
            commitMessage = `chore(release): ${plainList}`;
          }

          if (title.length > 250) {
            title = `Release: package versions ${releaseDate}`;
          }

          if (commitMessage.length > 250) {
            commitMessage = `chore(release): package versions ${releaseDate}`;
          }

          const outputPath = process.env.GITHUB_OUTPUT;
          require('node:fs').appendFileSync(outputPath, `title=${title}\n`, 'utf8');
          require('node:fs').appendFileSync(outputPath, `commit_message=${commitMessage}\n`, 'utf8');
          EOF

      - name: Create pull request with version bumps
        if: steps.covector.outputs.commandRan == 'version'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/covector
          title: ${{ steps.pr_meta.outputs.title }}
          commit-message: ${{ steps.pr_meta.outputs.commit_message }}
          labels: |
            version updates
            release
          body: ${{ steps.covector.outputs.change }}
